import streamlit as st
import pandas as pd
from causalimpact import CausalImpact
import matplotlib.pyplot as plt
from io import BytesIO

# --- Page Setup ---
st.set_page_config(page_title="Causal Impact Dashboard", layout="wide")
st.title("📉 Causal Impact Analysis (Brand Pause)")

# --- Load CSV Data ---
@st.cache_data
def load_data():
    df = pd.read_csv("dummy_data_ci.csv", parse_dates=["date"])
    return df

df = load_data()

# --- Check expected columns ---
expected_cols = {"date", "market", "conversions", "Paid Search", "Paid Social"}
if not expected_cols.issubset(df.columns):
    st.error(f"Missing columns in CSV. Expected columns: {expected_cols}")
    st.stop()

# --- Input for pause date ---
pause_date = st.date_input("🛑 Select pause start date", pd.to_datetime("2024-11-01"))

# --- Market selection ---
markets = df["market"].unique()
selected_market = st.selectbox("🌍 Select Market", markets)

# --- Run CausalImpact for selected market ---
df_m = df[df["market"] == selected_market].copy()
df_m = df_m[["date", "Paid Search", "Paid Social", "conversions"]]
df_m = df_m.set_index("date")

full_weeks = df_m.index.sort_values().unique()
pre_period = [full_weeks.min(), full_weeks[full_weeks < pd.to_datetime(pause_date)].max()]
post_period = [pd.to_datetime(pause_date), full_weeks.max()]

ci_data = df_m[["conversions", "Paid Search", "Paid Social"]]
impact = CausalImpact(ci_data, pre_period, post_period)

# --- Display Results ---
st.subheader("📊 Summary")
st.text(impact.summary())

st.subheader("📝 Full Report")
st.markdown(f"<pre>{impact.summary(output='report')}</pre>", unsafe_allow_html=True)

st.subheader("📈 Impact Plot")
fig = impact.plot(figsize=(10, 5))
buf = BytesIO()
fig.savefig(buf, format="png", bbox_inches="tight")
buf.seek(0)
st.image(buf)
